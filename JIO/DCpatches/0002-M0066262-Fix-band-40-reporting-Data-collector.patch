From e5b80395b7506a9723b1042764593543d10254f8 Mon Sep 17 00:00:00 2001
From: Ranjit Mishra <ranjit.mishra@borqs.com>
Date: Thu, 23 Nov 2017 18:10:23 +0530
Subject: [PATCH] M0066262 : Fix band 40 reporting(Data collector)

- Fix band 40 reporting to kaios metrics daemon

Change-Id: If6cec828b9a20ffe481289a85dcde914c74ac819
---
 b2g_telephony/NetworkDataCollector.cpp | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/b2g_telephony/NetworkDataCollector.cpp b/b2g_telephony/NetworkDataCollector.cpp
index 0b18cf4..e2a60cb 100755
--- a/b2g_telephony/NetworkDataCollector.cpp
+++ b/b2g_telephony/NetworkDataCollector.cpp
@@ -66,6 +66,11 @@ NS_NAMED_LITERAL_CSTRING(DATA_COLLECTOR_SERVER_SOCKET_NAME, "/dev/socket/metrics
 
 #define QCRIL_QMI_VOICE_MAX_FAIL_CAUSE_STR_LEN     256
 
+#define DC_ACTIVE_BAND_E_UTRA_OPERATING_BAND_3 122
+#define DC_ACTIVE_BAND_E_UTRA_OPERATING_BAND_5 124
+#define DC_ACTIVE_BAND_E_UTRA_OPERATING_BAND_40 142
+
+
 
 typedef struct
 {
@@ -474,6 +479,7 @@ const char* NetworkDataCollector::getDataCollectorEventCode(DataCollectorEventCo
 void NetworkDataCollector::sendNWDataToServer(qmi_ril_nw_data_collector_Params *pNetworkParams,DataCollectorEventCodes event) {
     uint8_t frame[MAX_RESPONSE_BYTES];
     bzero(frame,MAX_RESPONSE_BYTES);
+    int activeband = 0;
     QLOGD("NetworkDataCollector  sentNWDataToServer");
 
     if(mSeqNumber >= 0xFFFFFFFFFFFFFFFF)
@@ -484,11 +490,20 @@ void NetworkDataCollector::sendNWDataToServer(qmi_ril_nw_data_collector_Params *
     char jsonPayload[MAX_RESPONSE_BYTES];
     bzero(jsonPayload,MAX_RESPONSE_BYTES);
 
-    /*As per network_access_service_v01.h, QC's LTE band starts from 120.
+    /*As per network_access_service_v01.h, RJIL LTE band mappings are as mentioned below. (nas_active_band_enum_v01).
+     NAS_ACTIVE_BAND_E_UTRA_OPERATING_BAND_3_V01 = 122,
+     NAS_ACTIVE_BAND_E_UTRA_OPERATING_BAND_5_V01 = 124,
+     NAS_ACTIVE_BAND_E_UTRA_OPERATING_BAND_40_V01 = 142,
        Set default band as 0 as per RJIL spec V 9.3 if the band information is not correct*/
-    int activeband = (pNetworkParams->activeband > 119) ? (pNetworkParams->activeband-119):0;
-    if(!((activeband == 3) || (activeband == 5) || (activeband == 40) ))
+    if( pNetworkParams->activeband == DC_ACTIVE_BAND_E_UTRA_OPERATING_BAND_3) {
+        activeband = 3;
+    } else if (pNetworkParams->activeband == DC_ACTIVE_BAND_E_UTRA_OPERATING_BAND_5) {
+        activeband = 5;
+    } else if (pNetworkParams->activeband == DC_ACTIVE_BAND_E_UTRA_OPERATING_BAND_40) {
+        activeband = 40;
+    } else {
         activeband = 0;
+    }
 
     // Note:- as per 80-nv304-6_b_qmi_network_access_service_spec , RSRP range: -44 to -140, RSRQ range : -3 to -20, LTE SNR level scaled integer in units of 0.1dB e.g. 24.6 has a value of 246.
     sprintf (jsonPayload,"[{ \"seq_number\": %llu, \"timestamp\": %ld, \"payload\": { \"Name\":\"%s\",\"RI1\":%d,\"RI2\":%d,\"RI3\":%d,\"RI6\":%d,\"RI7\":%d,\"RI8\":%s,\"RI13\": %d,\"VI2\": %d,\"NI1\":%s,\"VI1\": \"%s\"}}]",
-- 
1.9.1

