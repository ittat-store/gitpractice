From d125f20d1f02afaff37ad110d79bfd159c02533c Mon Sep 17 00:00:00 2001
From: Ranjit Mishra <ranjit.mishra@borqs.com>
Date: Mon, 25 Sep 2017 17:24:14 +0530
Subject: [PATCH] M0064742: Update event NE2/NE4/NE5 clasification

Change-Id: Ie8ec09b76a0b5a21aefa55f73c2203abe1aad9e1
---

diff --git a/qcril/qcril_qmi/qcril_qmi_voice.c b/qcril/qcril_qmi/qcril_qmi_voice.c
index d7ebce5..2524c29 100755
--- a/qcril/qcril_qmi/qcril_qmi_voice.c
+++ b/qcril/qcril_qmi/qcril_qmi_voice.c
@@ -4830,6 +4830,23 @@
               }
             }
 
+            // Now, classify the failure cause depending on previous state
+            if(call_info_entry)
+            {
+                switch ( call_info_entry->voice_scv_info.call_state ) // check previous state
+                {
+                    //Only MO call can have call attempt failure
+                    case CALL_STATE_ORIGINATING_V02:
+                    case CALL_STATE_CC_IN_PROGRESS_V02:
+                    case CALL_STATE_ALERTING_V02:
+                    dataCollectorEvents = DATA_COLLECTOR_EVENT_CALL_ATTEMPT_FAILED;
+                    break;
+
+                default:
+                     QCRIL_LOG_ESSENTIAL("This one is either a MT call or, a connected call");
+                    break;
+              }
+            }
             // Ringback tone handling
             if(alerting_type_valid)
             {
@@ -4988,15 +5005,14 @@
             {
               qcril_qmi_voice_enable_voice_indications(FALSE);
             }
-            //Only MO call can have call attempt failure
-            if(((call_info_entry->voice_scv_info.call_state == CALL_STATE_ORIGINATING_V02) ||
-                (call_info_entry->voice_scv_info.call_state  == CALL_STATE_CC_IN_PROGRESS_V02)) &&
-                (call_info_entry->lcf_valid && (call_info_entry->lcf != CALL_FAIL_NORMAL))) {
-                dataCollectorEvents = DATA_COLLECTOR_EVENT_CALL_ATTEMPT_FAILED;
-            } else if (call_info_entry->lcf_valid && call_info_entry->lcf == CALL_FAIL_NORMAL) {
-                dataCollectorEvents = DATA_COLLECTOR_EVENT_CALL_DISCONNECT;
-            } else {
-                dataCollectorEvents = DATA_COLLECTOR_EVENT_CALL_DROP;
+
+            if(dataCollectorEvents != DATA_COLLECTOR_EVENT_CALL_ATTEMPT_FAILED)
+            {
+                if (call_info_entry->lcf_valid && call_info_entry->lcf == CALL_FAIL_NORMAL) {
+                    dataCollectorEvents = DATA_COLLECTOR_EVENT_CALL_DISCONNECT;
+                } else {
+                    dataCollectorEvents = DATA_COLLECTOR_EVENT_CALL_DROP;
+                }
             }
             if(call_info_entry->lcf_valid) {
                 QCRIL_LOG_ESSENTIAL("Initiate data collector last failed cause - %d", call_info_entry->lcf);
